{% extends "base.html" %} 
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

    <h2 class="text-3xl font-bold text-brand-dark-blue mb-6 border-b-2 border-gray-200 pb-2">Detail Pembayaran</h2>

    <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-brand-orange">

        <input type="hidden" id="harga-dasar-mentah" value="{{ total_price_mentah|default:0 }}">
        
        <div class="flex justify-between items-center mb-6">
            <span class="text-lg text-gray-400">1. Detail Pembeli</span>
            <span class="text-lg font-semibold text-brand-dark-blue">2. Detail Pembayaran</span>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <p class="text-sm text-gray-600">Order ID Anda:</p>
            <p class="text-2xl font-extrabold text-brand-orange">{{ pembelian.order_id }}</p>
            <p class="text-sm text-gray-600 mt-2">Status Pembayaran:</p>
            <p class="text-lg font-semibold text-red-600">{{ pembelian.get_status_display }}</p>
        </div>
        
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Total Pembayaran</h3>
            <div id="total-pembayaran-display" class="flex justify-between items-end p-3 bg-brand-light-blue rounded-md">
                <p class="text-white text-base">Total yang Harus Dibayar:</p>
                <input type="hidden" id="harga-final-db" value="{{ total_price_mentah|default:0 }}"> 
                <p class="text-white text-3xl font-extrabold" id="total-akhir-display">
                    Rp {{ total_price_mentah|default:0 }}
                </p>
            </div>
        </div>

        <div class="mb-6">
            <label for="voucher-input" class="block text-sm font-medium text-gray-700">Kode Voucher (Opsional)</label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" id="voucher-input"
                    class="focus:ring-brand-light-blue focus:border-brand-light-blue flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300">
                <button type="button" id="btn-check-voucher"
                    class="inline-flex items-center px-4 py-2 border border-l-0 border-brand-light-blue bg-brand-light-blue text-sm font-medium rounded-r-md text-white hover:bg-brand-dark-blue">
                    Cek
                </button>
            </div>
            <p id="voucher-message" class="mt-2 text-sm hidden"></p>
        </div>
        
        <div id="diskon-display"
            class="my-3 p-3 bg-green-50 border border-green-200 rounded-md hidden">
            <p class="text-sm font-semibold text-green-700 flex justify-between">
                <span>Diskon Voucher (<span id="voucher-code-applied"></span>)</span>
                <span id="diskon-amount-display"></span>
            </p>
        </div>  

        <hr class="my-6">

        <h3 class="text-xl font-semibold text-gray-700 mb-4">Pilih Metode Pembayaran</h3>
        
        <form id="form-pembayaran" enctype="multipart/form-data">
            {% csrf_token %}
            
            <input type="hidden" name="order_id" value="{{ pembelian.order_id }}">
            <input type="hidden" name="voucher_code_applied" id="voucher-code-applied-input">

            <div class="mb-6">
                <select id="metode_pembayaran" name="metode_pembayaran" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>Pilih metode...</option>
                    <option value="BRI">BRI</option>
                    <option value="BCA">BCA</option>
                    <option value="Mandiri">Mandiri</option>
                    <option value="Gopay">GoPay</option>
                    <option value="QRIS">QRIS</option>
                </select>
            </div>

            <div id="qris-display" class="hidden text-center mb-6">
                <img src="{% static 'images/qris.png' %}" class="mx-auto w-48">
            </div>

            <div id="bukti-transfer-container" class="hidden mb-6">
                <input type="file" id="bukti_transfer" name="bukti_transfer" accept="image/*">
            </div>

            <button type="submit" id="btn-konfirmasi-bayar"
                class="w-full px-6 py-3 bg-brand-orange text-white font-bold rounded-md" disabled>
                Pilih Metode Pembayaran
            </button>
        </form>

    </div>
</div>

<div id="modal-eticket" class="fixed inset-0 hidden bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 mx-auto mt-20 max-w-md rounded-lg">
        <h3 class="font-bold mb-4">E-Ticket Anda Siap!</h3>
        <button id="btn-tutup-eticket-modal"
            class="bg-brand-light-blue text-white px-4 py-2 rounded-md">
            Tutup
        </button>
    </div>
</div>

<script>
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const orderId = "{{ pembelian.order_id|escapejs }}";

    const voucherInput = document.getElementById('voucher-input');
    const btnCheckVoucher = document.getElementById('btn-check-voucher');
    const voucherMessage = document.getElementById('voucher-message');
    const diskonDisplay = document.getElementById('diskon-display');
    const totalAkhirDisplay = document.getElementById('total-akhir-display');
    const voucherCodeAppliedInput = document.getElementById('voucher-code-applied-input');

    const hargaDB = parseInt(document.getElementById('harga-final-db').value) || 0;
    let hargaFinal = hargaDB;

    function formatRupiah(n) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(n);
    }

    function updateHarga(n) {
        hargaFinal = n;
        totalAkhirDisplay.textContent = formatRupiah(n);
    }

    updateHarga(hargaDB);

    // === CEK VOUCHER ===
    btnCheckVoucher.addEventListener('click', async () => {
        const code = voucherInput.value.trim();
        if (!code) return;

        const formData = new FormData();
        formData.append('action', 'cek_voucher');
        formData.append('voucher_code', code);
        formData.append('harga_dasar', hargaDB);

        const res = await fetch("{% url 'payment:proses_bayar_ajax' order_id=pembelian.order_id %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: formData
        });

        const data = await res.json();
        if (data.status === 'success') {
            updateHarga(data.new_total);
            diskonDisplay.classList.remove('hidden');
            document.getElementById('voucher-code-applied').textContent = data.code;
            document.getElementById('diskon-amount-display').textContent =
                '- ' + formatRupiah(data.discount_amount);
            voucherCodeAppliedInput.value = data.code;
        }
    });

    // === SUBMIT PEMBAYARAN ===
    document.getElementById('form-pembayaran').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        formData.append('action', 'konfirmasi_bayar');

        const res = await fetch(
            "{% url 'payment:proses_bayar_ajax' order_id='0' %}".replace('0', orderId),
            {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                body: formData
            }
        );

        const data = await res.json();
        if (data.status === 'success') {
            document.getElementById('modal-eticket').classList.remove('hidden');
        }
    });

    document.getElementById('btn-tutup-eticket-modal').addEventListener('click', () => {
        document.getElementById('modal-eticket').classList.add('hidden');
        window.location.href = '/';
    });
</script>

{% endblock %}
