{% extends "base.html" %} 
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <h2 class="text-3xl font-bold text-brand-dark-blue mb-6 border-b-2 border-brand-dark-blue pb-2">Detail Pembayaran</h2>

    <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-brand-orange">
        
        <div class="flex justify-between items-center mb-6">
            <span class="text-lg text-gray-400">1. Detail Pembeli</span>
            <span class="text-lg font-semibold text-brand-dark-blue">2. Detail Pembayaran</span>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <p class="text-sm text-gray-600">Order ID Anda:</p>
            <p class="text-2xl font-extrabold text-brand-orange">{{ pembelian.order_id }}</p>
            <p class="text-sm text-gray-600 mt-2">Status Pembayaran:</p>
            <p class="text-lg font-semibold text-red-600">{{ pembelian.get_status_display }}</p>
        </div>
        
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Total Pembayaran</h3>
            <div class="flex justify-between items-end p-3 bg-brand-light-blue rounded-md">
                <p class="text-white text-base">Total yang Harus Dibayar:</p>
                <p class="text-white text-3xl font-extrabold">{{ total_harga_formatted }}</p>
            </div>
            <p class="text-sm text-red-500 mt-2">Mohon lakukan transfer sesuai total harga di atas sebelum batas waktu yang ditentukan.</p>
        </div>

        <hr class="my-6">

        <h3 class="text-xl font-semibold text-gray-700 mb-4">Pilih Metode Pembayaran</h3>
        
        <form id="form-pembayaran" enctype="multipart/form-data">
            {% csrf_token %}
            
            <input type="hidden" name="order_id" value="{{ pembelian.order_id }}">

            <div class="mb-6">
                <label for="metode_pembayaran" class="block text-sm font-medium text-gray-700 mb-2">Pilih Bank / E-Wallet</label>
                <select id="metode_pembayaran" name="metode_pembayaran" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-brand-light-blue focus:border-brand-light-blue sm:text-sm">
                    <option value="" disabled selected>Pilih salah satu...</option>
                    <option value="BRI">BRI - 0123456789 (a/n SERVE.TIX)</option>
                    <option value="BCA">BCA - 9876543210 (a/n SERVE.TIX)</option>
                    <option value="Mandiri">Mandiri - 1122334455 (a/n SERVE.TIX)</option>
                    <option value="Gopay">Gopay</option>
                    <option value="QRIS">QRIS</option>
                </select>
            </div>

            <div id="voucher-input-container" class="mb-6">
                <label for="voucher" class="block text-sm font-medium text-gray-700 mb-2">Kode Voucher (Opsional)</label>
                <input type="text" id="voucher" name="kode_voucher" placeholder="Masukkan Kode Voucher jika ada" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-light-blue focus:border-brand-light-blue sm:text-sm">
            </div>
            <div id="qris-display" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-md hidden">
                <p class="font-semibold text-gray-700 mb-3">Detail Pembayaran QRIS / Gopay:</p>
                <p class="text-sm text-gray-600 mb-4">Scan QR Code di bawah ini untuk menyelesaikan pembayaran Anda:</p>
                <div class="flex justify-center">
                    <img src="{% static 'payment/img/qris_placeholder.png' %}" 
                         alt="QRIS Code" 
                         class="w-48 h-48 object-contain border border-gray-300 p-2 rounded-lg">
                </div>
            </div>

            <div id="bukti-transfer-container" class="mb-6 hidden">
                <label for="bukti_transfer" class="block text-sm font-medium text-gray-700 mb-2">Upload Bukti Transfer (Max 2MB)</label>
                <input type="file" id="bukti_transfer" name="bukti_transfer" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-light-blue file:text-white hover:file:bg-brand-dark-blue">
            </div>

            <button type="submit" id="btn-konfirmasi-bayar" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-brand-orange hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-orange font-bold" disabled>
                Pilih Metode Pembayaran
            </button>
        </form>

    </div>
</div>

<div id="modal-eticket" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-5 mx-auto p-5 border w-96 max-w-lg shadow-lg rounded-md bg-white">
        <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">E-Ticket Anda Siap!</h3>
        <p class="text-sm text-gray-600 mb-4">Tiket ini telah diproses dan akan dikirim ke email **{{ pembelian.email }}**.</p>
        
        <div id="container-etickets" class="space-y-6">
            {% for tiket in pembelian.tikets.all %}
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <div class="flex items-center space-x-3 mb-3 p-2 bg-brand-gold bg-opacity-30 rounded-md">
                    <span class="text-3xl text-brand-dark-blue">üéüÔ∏è</span> 
                    <div>
                        <p class="font-bold text-brand-dark-blue">{{ pembelian.match.title }}</p>
                        <p class="text-xs text-gray-700">{{ pembelian.match.venue.name }} | {{ pembelian.match.start_time|date:"j F H:i" }}</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-3">
                    <div class="text-left">
                        <p class="text-sm font-semibold text-gray-800">Order ID: <span class="font-mono text-brand-orange">{{ pembelian.order_id }}</span></p>
                        <p class="text-sm font-semibold text-gray-800">Pemegang: {{ tiket.nama_pemegang }}</p>
                        <p class="text-sm text-gray-600">Kategori: **{{ tiket.kategori_kursi|title }}**</p>
                    </div>
                    
                    <div class="w-24 h-24 border p-1" id="qr-display-{{ tiket.id }}">
                        <img src="{% if tiket.file_qr_code %}{{ tiket.file_qr_code.url }}{% else %}/media/qrcodes/dummy.png{% endif %}" 
                             alt="QR Code" 
                             class="w-full h-full" 
                             id="qr-img-{{ tiket.id }}">
                        
                        <p class="text-xs text-center text-gray-500" id="qr-text-{{ tiket.id }}" 
                           style="{% if tiket.file_qr_code %}display:none;{% endif %}">QR loading...</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="items-center px-4 py-3 border-t mt-4 flex justify-between">
            <button id="btn-unduh-tiket" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-md hover:bg-gray-300">
                <span class="flex items-center"><svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Unduh</span>
            </button>
            <button id="btn-tutup-eticket-modal" class="px-4 py-2 bg-brand-light-blue text-white text-base font-medium rounded-md shadow-sm hover:bg-brand-dark-blue">
                Tutup
            </button>
        </div>
    </div>
</div>

<script>
    const formPembayaran = document.getElementById('form-pembayaran');
    const selectMetode = document.getElementById('metode_pembayaran');
    const qrisDisplay = document.getElementById('qris-display');
    const inputBuktiTransfer = document.getElementById('bukti_transfer');
    const transferContainer = document.getElementById('bukti-transfer-container');
    const btnKonfirmasiBayar = document.getElementById('btn-konfirmasi-bayar');
    const modalEticket = document.getElementById('modal-eticket'); 

    const orderId = "{{ pembelian.order_id|escapejs }}";
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- Logika Interaksi Form (Sama) ---
    selectMetode.addEventListener('change', function() {
        const metode = this.value;
        const isBankTransfer = ['BRI', 'BCA', 'Mandiri'].includes(metode);

        // 1. Tampilkan/Sembunyikan QRIS Display
        if (metode === 'Gopay' || metode === 'QRIS') {
            qrisDisplay.classList.remove('hidden');
        } else {
            qrisDisplay.classList.add('hidden');
        }

        // 2. Atur Input Bukti Transfer (Visibility, Required, Button State)
        if (isBankTransfer) {
            transferContainer.classList.remove('hidden');
            inputBuktiTransfer.required = true;
            btnKonfirmasiBayar.textContent = 'Konfirmasi Pembayaran';
            btnKonfirmasiBayar.disabled = true;
        } else {
            transferContainer.classList.add('hidden');
            inputBuktiTransfer.required = false;
            inputBuktiTransfer.value = ''; 
            btnKonfirmasiBayar.textContent = 'Bayar Sekarang';
            btnKonfirmasiBayar.disabled = false;
        }
    });
    
    // 3. Logika Konfirmasi Otomatis (Sama)
    inputBuktiTransfer.addEventListener('change', function() {
        if (this.files.length > 0) {
            btnKonfirmasiBayar.disabled = false;
        } else {
            btnKonfirmasiBayar.disabled = true;
        }
    });
    
    // --- Logika AJAX (Perbaikan Final QR Load) ---
    formPembayaran.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!formPembayaran.checkValidity()) {
            formPembayaran.reportValidity();
            return;
        }

        btnKonfirmasiBayar.disabled = true;
        btnKonfirmasiBayar.textContent = 'Memproses...';

        const formData = new FormData(formPembayaran);
        
        const apiUrl = "{% url 'payment:proses_bayar_ajax' order_id='0' %}".replace('0', orderId);

        fetch(apiUrl, {
            method: 'POST',
            body: formData, 
            headers: {
                'X-CSRFToken': CSRF_TOKEN 
            },
        })
        .then(response => {
            if (!response.ok) {
                // Mencoba membaca error response JSON
                return response.json().then(err => { 
                    throw new Error(err.message || `Gagal dengan status ${response.status}.`); 
                }).catch(() => {
                    throw new Error(`Terjadi kesalahan server (${response.status}). Cek konsol server.`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // 1. Targetkan setiap QR Code dan paksa reload
                document.querySelectorAll('[id^="qr-img-"]').forEach(imgElement => {
                    const tiketId = imgElement.id.split('-').pop();
                    const textNode = document.getElementById('qr-text-' + tiketId);

                    // Pastikan elemen ditemukan
                    if (imgElement) {
                        // Paksa browser reload dengan menambahkan timestamp ke URL asli
                        // URL asli adalah URL ke QR code yang baru dibuat oleh server
                        imgElement.src = imgElement.src.split("?")[0] + "?" + new Date().getTime();
                        
                        // Sembunyikan teks loading dan tampilkan gambar
                        imgElement.style.display = 'block';
                        if (textNode) {
                            textNode.style.display = 'none';
                        }
                    }
                });
                
                // 2. Tampilkan modal E-Ticket
                modalEticket.classList.remove('hidden');

            } else {
                alert('Gagal konfirmasi pembayaran: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat memproses pembayaran: ' + error.message);
        })
        .finally(() => {
            btnKonfirmasiBayar.disabled = false;
            btnKonfirmasiBayar.textContent = 'Konfirmasi Pembayaran';
        });
    });
    
    // Event Listener untuk tombol Tutup di Modal E-Ticket
    document.getElementById('btn-tutup-eticket-modal').addEventListener('click', function() {
        modalEticket.classList.add('hidden');
        window.location.href = '/'; 
    });
</script>
{% endblock %} 