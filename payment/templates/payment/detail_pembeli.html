{% extends "base.html" %} 
{% load static %}
{% load humanize %} 

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <h2 class="text-3xl font-bold text-brand-dark-blue mb-6 border-b-2 border-brand-dark-blue pb-2">
        Detail Pembeli
    </h2>

    <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-brand-orange">
        
        <div class="flex justify-between items-center mb-6">
            <span class="text-lg font-semibold text-brand-dark-blue">1. Detail Pembeli</span>
            <span class="text-lg text-gray-400">2. Detail Pembayaran</span>
        </div>

        <div class="mb-6 bg-yellow-100 border-l-4 border-brand-gold p-4 rounded-md">
            <h3 class="font-bold text-gray-800">Pertandingan yang Dipilih:</h3>
            <p class="text-xl text-brand-dark-blue">{{ match.title }}</p>
            <p class="text-sm text-gray-600">
                {{ match.venue.name }} - {{ match.start_time|date:"j F Y, H:i" }}
            </p>
        </div>

        <form id="form-detail-pembeli" method="POST" novalidate>
            {% csrf_token %}

            <input type="hidden" id="match_id" value="{{ match.id }}">

            <!-- KATEGORI -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Pilih Kategori Tiket</h3>
            <div class="mb-6">
                <select id="kategori_tempat_duduk" required
                    class="block w-full border rounded px-3 py-2">
                    <option value="" disabled selected>Pilih Kategori</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}"
                                data-price="{{ cat.price }}"
                                data-name="{{ cat.name }}">
                            {{ cat.name }} (Rp {{ cat.price|intcomma }})
                        </option>
                    {% endfor %}
                </select>
                <p id="harga-satuan-display"
                   class="mt-2 text-sm text-brand-orange font-semibold hidden">
                   Harga Satuan: Rp 0
                </p>
            </div>

            <hr class="my-6">

            <!-- KONTAK -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Informasi Kontak</h3>

            <input type="text" name="nama_lengkap" required
                   placeholder="Nama Lengkap"
                   class="w-full mb-3 border rounded px-3 py-2">

            <input type="email" name="email" required
                   placeholder="Email"
                   class="w-full mb-3 border rounded px-3 py-2">

            <input type="tel" name="nomor_telepon" required
                   placeholder="Nomor Telepon"
                   class="w-full mb-6 border rounded px-3 py-2">

            <hr class="my-6">

            <!-- TIKET 1 -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
                Detail Pemegang Tiket 1
            </h3>

            <input type="text" name="nama_tiket_1" required
                   placeholder="Nama pada tiket"
                   class="w-full mb-3 border rounded px-3 py-2">

            <div class="flex gap-4 mb-6">
                <label><input type="radio" name="jenis_kelamin_1" value="L" checked> L</label>
                <label><input type="radio" name="jenis_kelamin_1" value="P"> P</label>
            </div>

            <div id="container-tiket-tambahan"></div>

            <button type="button" id="tambah-tiket"
                class="mb-6 px-4 py-2 border rounded bg-gray-100">
                + Tambah Tiket
            </button>

            <div class="flex justify-end">
                <button type="button" id="btn-konfirmasi-total"
                    class="px-6 py-3 bg-brand-orange text-white rounded font-bold">
                    Konfirmasi & Cek Harga Total
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL -->
<div id="modal-konfirmasi"
     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded p-6 w-96">
        <h3 class="text-lg font-bold mb-4">Konfirmasi Pembelian</h3>
        <p>Total Tiket: <span id="modal-total-tiket">1</span></p>
        <p>Kategori: <span id="modal-kategori-kursi">-</span></p>
        <p class="text-xl font-bold mt-2">
            Total Harga:
            <span id="modal-total-harga" class="text-brand-orange">Rp 0</span>
        </p>

        <button id="btn-lanjut-pembayaran"
            class="mt-4 w-full bg-brand-light-blue text-white py-2 rounded">
            Lanjutkan ke Pembayaran
        </button>
    </div>
</div>

<!-- JS -->
<script src="{% static 'payment/js/payment_logic.js' %}"></script>

<script>
document.getElementById("btn-konfirmasi-total").addEventListener("click", function () {
    const kategori = document.getElementById("kategori_tempat_duduk");
    const selected = kategori.options[kategori.selectedIndex];
    if (!selected || !selected.dataset.price) {
        alert("Pilih kategori terlebih dahulu");
        return;
    }

    const harga = parseInt(selected.dataset.price);
    document.getElementById("modal-total-tiket").textContent = "1";
    document.getElementById("modal-kategori-kursi").textContent = selected.dataset.name;
    document.getElementById("modal-total-harga").textContent =
        new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0
        }).format(harga);

    document.getElementById("modal-konfirmasi").classList.remove("hidden");
});
</script>
{% endblock %}
