{% extends 'base.html' %}
{% load static %}
{% block title %}Forum Threads{% endblock title %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/forums.css' %}">

<div class="max-w-5xl mx-auto mt-10 px-4">

  <!-- HEADER -->
  <h2 class="text-3xl font-bold text-brand-dark-blue mb-6 text-center">
    <i class='far fa-comment-alt'></i> Forum Penggemar 
  </h2>

  <!-- ========================= -->
  <!-- FORM BUAT THREAD BARU -->
  <!-- ========================= -->
  <div class="bg-[#fdf4d9] rounded-2xl shadow-md p-6 mb-8 border-l-4 border-brand-gold">
    <h5 class="text-xl font-semibold text-brand-dark-blue mb-4">Buat Thread Baru</h5>

    <form id="create-thread-form" method="post" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="title" class="block font-semibold text-gray-700 mb-1">Judul</label>
        <input type="text" name="title" id="title"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-gold"
               placeholder="Tulis judul thread kamu..." required>
      </div>

      <div>
        <label for="content" class="block font-semibold text-gray-700 mb-1">Isi Thread</label>
        <textarea name="content" id="content" rows="3"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-gold"
                  placeholder="Tulis isi diskusi kamu di sini..." required></textarea>
      </div>

      <button type="submit"
              class="bg-brand-gold hover:bg-yellow-400 text-brand-dark-blue font-bold py-2 px-5 rounded-lg shadow transition">
        Kirim
      </button>
    </form>
  </div>

  <!-- ========================= -->
  <!-- DAFTAR THREAD DALAM CARD -->
  <!-- ========================= -->
  <div id="thread-list" class="space-y-6">
    {% for thread in threads %}
      {% include "forums/threads/thread_card.html" %}
    {% empty %}
      <p class="text-center text-gray-600 italic">Belum ada thread. Jadilah yang pertama!</p>
    {% endfor %}
  </div>
</div>

<!-- ========================= -->
<!-- JAVASCRIPT HANDLERS -->
<!-- ========================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// === Ambil CSRF token dari cookie ===
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$(document).ready(function() {
  
  // === ENSURE NOTIFICATION BUTTON WORKS ===
  // Pastikan handler notifikasi tetap berfungsi - gunakan namespace yang sama dengan base.html
  // Delay sedikit untuk memastikan base.html handler sudah terdaftar dulu
  setTimeout(function() {
    if (typeof jQuery !== 'undefined' && jQuery('#notifButton').length > 0) {
      // Re-register dengan namespace yang sama dengan base.html (.notif)
      jQuery('#notifButton').off('click.notif.forum').on('click.notif.forum', function(e) {
        e.stopPropagation();
        e.stopImmediatePropagation();
        const dropdown = document.getElementById('notifDropdown');
        if (!dropdown) return false;
        
        const isHidden = dropdown.classList.contains('hidden');
        dropdown.classList.toggle('hidden');
        
        if (!isHidden) {
          // Dropdown was open, now closing
        } else {
          // Dropdown was closed, now opening - fetch notifications
          if (typeof window.fetchUnreadAndRender === 'function') {
            window.fetchUnreadAndRender();
          }
        }
        return false;
      });
    }
  }, 200); // Delay lebih lama untuk memastikan base.html sudah selesai

  // === CREATE THREAD ===
  $('#create-thread-form').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();

    $.ajax({
      url: "{% url 'forums:create_thread_ajax' %}",
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      data: formData,
      success: function(response) {
        if (response.success) {
          // Tambahkan thread baru ke atas daftar
          $('#thread-list').prepend(response.html);
          $('#create-thread-form')[0].reset();

          // Efek muncul lembut
          $('#thread-list .box').first().hide().fadeIn(400);
          
          // Trigger update notifikasi (jika ada user lain yang akan dapat notifikasi)
          setTimeout(function() {
            if (typeof window.fetchUnreadAndRender === 'function') {
              window.fetchUnreadAndRender();
            }
          }, 300);
        } else {
          alert("Terjadi kesalahan: " + JSON.stringify(response.errors));
        }
      },
      error: function(xhr) {
        console.log(xhr.responseText);
        alert("Gagal membuat thread. Pastikan kamu sudah login.");
      }
    });
  });

  // === THREAD VOTING HANDLER ===
  // Hanya bind pada elemen dalam thread-list, bukan seluruh document untuk menghindari konflik dengan navbar
  // Gunakan delegated event handler yang lebih spesifik
  $('#thread-list').off('click.vote').on('click.vote', '.btn-upvote-thread, .btn-downvote-thread', function(e) {
    // PASTIKAN: Handler ini HANYA untuk elemen dalam #thread-list
    // Jika klik berasal dari luar thread-list (misalnya navbar), abaikan sepenuhnya
    const $clicked = $(e.target);
    const $btn = $(this);
    
    // Cek apakah klik berasal dari navbar atau elemen notifikasi - jika ya, biarkan event berlanjut
    if ($clicked.closest('nav').length > 0 || 
        $clicked.closest('header').length > 0 ||
        $clicked.closest('#notifButton').length > 0 || 
        $clicked.closest('#notifDropdown').length > 0 ||
        $btn.closest('nav').length > 0 ||
        $btn.closest('header').length > 0) {
      return true; // Biarkan event berlanjut untuk handler lain (termasuk notifikasi)
    }
    
    // Pastikan ini benar-benar tombol vote atau icon di dalamnya
    if (!$btn.hasClass('btn-upvote-thread') && 
        !$btn.hasClass('btn-downvote-thread') &&
        !$clicked.closest('.btn-upvote-thread').length &&
        !$clicked.closest('.btn-downvote-thread').length) {
      return true; // Biarkan event berlanjut
    }
    
    // Hanya stop propagation jika benar-benar menangani vote
    e.preventDefault();
    e.stopPropagation();
    
    // Cari thread-card-wrapper yang memiliki data-thread-id
    const threadWrapper = $(this).closest('.thread-card-wrapper');
    let threadId = threadWrapper.data('thread-id');
    
    // Fallback: coba ambil dari ID element
    if (!threadId && threadWrapper.attr('id')) {
      const idMatch = threadWrapper.attr('id').match(/thread-(\d+)/);
      if (idMatch) {
        threadId = idMatch[1];
      }
    }
    
    const action = $(this).data('action');
    
    if (!threadId) {
      console.error('Thread ID tidak ditemukan', threadWrapper);
      alert("Gagal mendapatkan ID thread.");
      return;
    }

    // Disable button sementara untuk mencegah double click
    const originalHtml = $btn.html();
    $btn.prop('disabled', true);
    
    // Simpan reference ke button untuk digunakan di complete handler
    const $buttonToReenable = $btn;

    // Build URL - Django URL pattern: ajax/<int:thread_id>/vote/
    // Gunakan base URL dari Django dan replace placeholder dengan threadId
    const baseUrl = "{% url 'forums:vote_thread_ajax' 0 %}";
    // Replace semua kemunculan '/0/' dengan threadId
    const voteUrl = baseUrl.replace(/\/0\//g, '/' + threadId + '/');
    
    $.ajax({
      url: voteUrl,
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      data: { action: action },
      success: function(response) {
        if (response.success) {
          $(`#thread-${threadId}-score`).text(response.score);
        } else {
          alert("Gagal memberikan suara: " + (response.message || ''));
        }
      },
      error: function(xhr) {
        console.error('Vote error:', xhr);
        let errorMsg = "Terjadi kesalahan jaringan.";
        if (xhr.status === 403) {
          errorMsg = "Anda harus login untuk memberikan suara.";
        } else if (xhr.status === 404) {
          errorMsg = "Thread tidak ditemukan.";
        } else if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg = xhr.responseJSON.error;
        }
        alert(errorMsg);
      },
      complete: function() {
        // Re-enable button setelah selesai
        $buttonToReenable.prop('disabled', false);
      }
    });
  });
  
  // === ENSURE MARK ALL READ BUTTON WORKS ===
  // Pastikan handler "tandai semua dibaca" tetap berfungsi setelah jQuery dimuat
  $('#markAllReadBtn').off('click.jqmarkread').on('click.jqmarkread', function(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const badge = document.getElementById('notif-badge');
    const dropdownContent = document.getElementById('notifDropdownContent');
    
    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');
    
    fetch("{% url 'notifications:notification_mark_all_read' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        if (badge) badge.classList.add('hidden');
        if (dropdownContent) {
          dropdownContent.innerHTML = '<div class="p-3 text-[#1e2c4f]/70 text-sm italic">Semua notifikasi sudah dibaca.</div>';
        }
      }
    })
    .catch(err => {
      console.error('Error marking all as read:', err);
    });
    
    return false;
  });
});
</script>
{% endblock content %}
