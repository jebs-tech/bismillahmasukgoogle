{% extends 'base.html' %}
{% load static %}
{% block title %}Forum Threads{% endblock title %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/forums.css' %}">

<div class="max-w-5xl mx-auto mt-10 px-4">

  <!-- HEADER -->
  <h2 class="text-3xl font-bold text-brand-dark-blue mb-6 text-center">
    <i class='far fa-comment-alt'></i> Forum Penggemar 
  </h2>

  <!-- ========================= -->
  <!-- FORM BUAT THREAD BARU -->
  <!-- ========================= -->
  <div class="bg-[#fdf4d9] rounded-2xl shadow-md p-6 mb-8 border-l-4 border-brand-gold">
    <h5 class="text-xl font-semibold text-brand-dark-blue mb-4">Buat Thread Baru</h5>

    <form id="create-thread-form" method="post" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="title" class="block font-semibold text-gray-700 mb-1">Judul</label>
        <input type="text" name="title" id="title"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-gold"
               placeholder="Tulis judul thread kamu..." required>
      </div>

      <div>
        <label for="content" class="block font-semibold text-gray-700 mb-1">Isi Thread</label>
        <textarea name="content" id="content" rows="3"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-gold"
                  placeholder="Tulis isi diskusi kamu di sini..." required></textarea>
      </div>

      <button type="submit"
              class="bg-brand-gold hover:bg-yellow-400 text-brand-dark-blue font-bold py-2 px-5 rounded-lg shadow transition">
        Kirim
      </button>
    </form>
  </div>

  <!-- ========================= -->
  <!-- DAFTAR THREAD DALAM CARD -->
  <!-- ========================= -->
  <div id="thread-list" class="space-y-6">
    {% for thread in threads %}
      {% include "forums/threads/thread_card.html" %}
    {% empty %}
      <p class="text-center text-gray-600 italic">Belum ada thread. Jadilah yang pertama!</p>
    {% endfor %}
  </div>
</div>

<!-- ========================= -->
<!-- JAVASCRIPT HANDLERS -->
<!-- ========================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// === Ambil CSRF token dari cookie ===
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$(document).ready(function() {

  // === CREATE THREAD ===
  $('#create-thread-form').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();

    $.ajax({
      url: "{% url 'forums:create_thread_ajax' %}",
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      data: formData,
      success: function(response) {
        if (response.success) {
          // Tambahkan thread baru ke atas daftar
          $('#thread-list').prepend(response.html);
          $('#create-thread-form')[0].reset();

          // Efek muncul lembut
          $('#thread-list .box').first().hide().fadeIn(400);
          
          // Trigger update notifikasi (jika ada user lain yang akan dapat notifikasi)
          setTimeout(function() {
            if (typeof window.fetchUnreadAndRender === 'function') {
              window.fetchUnreadAndRender();
            }
          }, 300);
        } else {
          alert("Terjadi kesalahan: " + JSON.stringify(response.errors));
        }
      },
      error: function(xhr) {
        console.log(xhr.responseText);
        alert("Gagal membuat thread. Pastikan kamu sudah login.");
      }
    });
  });

  // === THREAD VOTING HANDLER ===
  // Hanya bind pada elemen dalam thread-list, bukan seluruh document untuk menghindari konflik dengan navbar
  $('#thread-list').on('click', '.btn-upvote-thread, .btn-downvote-thread', function(e) {
    // Pastikan tidak tertangkap jika ada di navbar
    if ($(this).closest('nav').length > 0 || $(this).closest('#notifButton').length > 0) {
      return;
    }
    const threadCard = $(this).closest('.thread-card');
    const threadId = threadCard.data('thread-id');
    const action = $(this).data('action');

    $.ajax({
      url: `/forums/ajax/${threadId}/vote/`,
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      data: { action: action },
      success: function(response) {
        if (response.success) {
          $(`#thread-${threadId}-score`).text(response.score);
        } else {
          alert("Gagal memberikan suara: " + (response.message || ''));
        }
      },
      error: function(xhr) {
        console.log(xhr.responseText);
        alert("Terjadi kesalahan jaringan.");
      }
    });
  });
  
  // === ENSURE NOTIFICATION BUTTON WORKS ===
  // Pastikan handler notifikasi tetap berfungsi setelah jQuery dimuat
  // Re-register handler untuk memastikan kompatibilitas dengan jQuery
  $('#notifButton').off('click.jqnotif').on('click.jqnotif', function(e) {
    e.stopPropagation();
    e.stopImmediatePropagation();
    const dropdown = document.getElementById('notifDropdown');
    if (!dropdown) return false;
    
    const isHidden = dropdown.classList.contains('hidden');
    dropdown.classList.toggle('hidden');
    
    if (!isHidden) {
      // Dropdown was open, now closing
    } else {
      // Dropdown was closed, now opening - fetch notifications
      // Cek jika function fetchUnreadAndRender tersedia (dari base.html)
      if (typeof window.fetchUnreadAndRender === 'function') {
        window.fetchUnreadAndRender();
      } else if (typeof fetchUnreadAndRender === 'function') {
        fetchUnreadAndRender();
      } else {
        // Fallback: langsung fetch
        const badge = document.getElementById('notif-badge');
        const dropdownContent = document.getElementById('notifDropdownContent');
        if (dropdownContent) {
          fetch("{% url 'notifications:notification_unread_count' %}")
            .then(r => r.json())
            .then(data => {
              const count = data.unread_count || 0;
              if (count > 0 && badge) {
                badge.textContent = count;
                badge.classList.remove('hidden');
              } else if (badge) {
                badge.classList.add('hidden');
              }
              if (!dropdown.classList.contains('hidden')) {
                if (count > 0 && data.html) {
                  dropdownContent.innerHTML = data.html;
                } else {
                  dropdownContent.innerHTML = '<div class="p-4 text-sm text-[#1e2c4f]/60 italic text-center">Tidak ada notifikasi baru.</div>';
                }
              }
            })
            .catch(() => {});
        }
      }
    }
    return false;
  });
  
  // === ENSURE MARK ALL READ BUTTON WORKS ===
  // Pastikan handler "tandai semua dibaca" tetap berfungsi setelah jQuery dimuat
  $('#markAllReadBtn').off('click.jqmarkread').on('click.jqmarkread', function(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const badge = document.getElementById('notif-badge');
    const dropdownContent = document.getElementById('notifDropdownContent');
    
    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');
    
    fetch("{% url 'notifications:notification_mark_all_read' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        if (badge) badge.classList.add('hidden');
        if (dropdownContent) {
          dropdownContent.innerHTML = '<div class="p-3 text-[#1e2c4f]/70 text-sm italic">Semua notifikasi sudah dibaca.</div>';
        }
      }
    })
    .catch(err => {
      console.error('Error marking all as read:', err);
    });
    
    return false;
  });
});
</script>
{% endblock content %}
