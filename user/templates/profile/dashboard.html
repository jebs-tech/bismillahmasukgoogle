{% extends "base.html" %}

{% block content %}

{% with baseButtonClasses="block w-full text-left px-4 py-3 font-semibold text-gray-700 bg-white border border-gray-200 rounded-lg transition duration-200 ease-in-out hover:bg-gray-50 hover:border-gray-300" %}

<div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
    
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-4 rounded-lg 
                        {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-200 
                        {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-200
                        {% else %} bg-blue-100 text-blue-800 border border-blue-200 {% endif %}" 
                 role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    <h1 class="text-3xl font-bold text-gray-900">Dashboard Akun</h1>
    <p class="mt-2 text-lg text-gray-700" id="user-greeting">
        Halo, <span class="font-semibold">{{ user.profile.nama_lengkap|default:user.username }}</span>!
    </p>

    <div class="flex flex-col md:flex-row mt-8 gap-8">
        
        <div class="w-full md:w-1/4">
            <nav class="flex flex-col space-y-2" role="group">
                
                <button hx-get="{% url 'user:get_active_tickets' %}" 
                        hx-target="#dashboard-content" 
                        hx-swap="innerHTML"
                        class="nav-button active {{ baseButtonClasses }}">
                    Tiket Aktif Saya
                </button>
                
                <button hx-get="{% url 'user:get_purchase_history' %}" 
                        hx-target="#dashboard-content" 
                        hx-swap="innerHTML"
                        class="nav-button {{ baseButtonClasses }}">
                    Riwayat Pembelian
                </button>

                <button hx-get="{% url 'user:get_preferred_teams' %}" 
                        hx-target="#dashboard-content" 
                        hx-swap="innerHTML"
                        class="nav-button {{ baseButtonClasses }}">
                    Tim Favorit
                </button>

                <button hx-get="{% url 'user:edit_profile' %}"
                        hx-target="#dashboard-content"
                        hx-select="#edit-profile-content"
                        hx-swap="innerHTML"
                        class="nav-button {{ baseButtonClasses }}">
                    Edit Profil
                </button>

                <button hx-get="{% url 'user:get_delete_form' %}"
                        hx-target="#dashboard-content"
                        hx-swap="innerHTML"
                        class="nav-button {{ baseButtonClasses }} !text-red-600 !border-red-300 hover:!bg-red-50">
                    Hapus Akun
                </button>
                
                <a href="{% url 'user:logout' %}" 
                   class="nav-button {{ baseButtonClasses }} !text-gray-500 !border-gray-300 hover:!bg-gray-100">
                    Logout
                </a>
            </nav>
        </div>

        <div class="w-full md:w-3/4 bg-white rounded-lg shadow-xl p-6 min-h-[300px]">
            <div id="dashboard-content" 
                 hx-get="{% url 'user:get_active_tickets' %}" 
                 hx-trigger="load"
                 class="relative">

                 
                <div class="htmx-indicator absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-orange"></div>
                </div>

                <div class="flex flex-col items-center justify-center pt-16 text-center">
                    <div class="bg-brand-dark-blue text-white font-bold text-3xl px-6 py-2 rounded-lg shadow-lg inline-block">
                        SERVE.TIX
                    </div>
                    <h3 class="mt-6 text-2xl font-semibold text-gray-700">Selamat Datang, {{ user.profile.nama_lengkap|default:user.username }}!</h3>
                    <p class="mt-2 text-gray-500">Pilih menu di sebelah kiri untuk melihat detail akun Anda.</p>
                </div>

            </div>
        </div>

    </div>
</div>

{% endwith %}


<style>
    .nav-button.active {
        background-color: #FEF3C7; 
        border-color: #FDBA74;
        color: #B45309;
        font-weight: 700;
    }
</style>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const navContainer = document.querySelector('nav[role="group"]');
        if (navContainer) {
            navContainer.addEventListener('click', function(e) {
                const clickedButton = e.target.closest('.nav-button');
                
                if (!clickedButton || !clickedButton.hasAttribute('hx-get')) return;

                navContainer.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                clickedButton.classList.add('active');
            });
        }

        // Menangani 'active' state setelah htmx load
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            const navContainer = document.querySelector('nav[role="group"]');
            if (!navContainer) return;

            // Dapatkan URL yang baru saja dimuat
            const requestUrl = evt.detail.xhr.responseURL;

            navContainer.querySelectorAll('.nav-button').forEach(btn => {
                const btnUrl = btn.getAttribute('hx-get');
                if (btnUrl && requestUrl.includes(btnUrl)) {
                    btn.classList.add('active');
                } else if (btn.tagName.toLowerCase() !== 'a') { 
                    // Jangan hapus 'active' dari link (seperti Logout), hanya dari tombol
                    btn.classList.remove('active');
                }
            });
        });

        // Set 'active' state pada tombol pertama saat load awal
        const firstActiveButton = document.querySelector('nav[role="group"] .nav-button.active');
        if (!firstActiveButton) {
            const firstButton = document.querySelector('nav[role="group"] .nav-button[hx-get]');
            if (firstButton) {
                firstButton.classList.add('active');
            }
        }
    });
</script>
{% endblock %}